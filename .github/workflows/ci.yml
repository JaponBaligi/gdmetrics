name: CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read

jobs:
  test:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Godot
      run: |
        wget -q https://github.com/godotengine/godot/releases/download/4.2-stable/Godot_v4.2-stable_linux.x86_64.zip
        unzip -q Godot_v4.2-stable_linux.x86_64.zip
        sudo mv Godot_v4.2-stable_linux.x86_64 /usr/local/bin/godot
        sudo chmod +x /usr/local/bin/godot
        godot --version
    
    - name: Run CLI Analysis Test
      run: |
        godot --headless --path . --script cli/ci_test.gd -- --project-path . --output ci_report.json
    
    - name: Validate JSON Output
      run: |
        python3 -c "import json, sys; json.load(open('ci_report.json')); print('JSON is valid')"
    
    - name: Check Report Structure
      run: |
        python3 cli/validate_report.py ci_report.json
    
    - name: Validate Parser Stability
      run: |
        godot --headless --path . --script tests/validate_parser_stability.gd -- --project-path .

