# Technical Documentation

## Architecture Overview

The analyzer is a Godot EditorPlugin with a shared core used by both the editor UI and CLI.

Main components:
- **Plugin/UI**: `addons/gdscript_complexity/plugin.gd` and dock UI. Handles user actions and displays results.
- **Async analysis**: `addons/gdscript_complexity/gd3/async_analyzer.gd` and `addons/gdscript_complexity/gd4/async_analyzer.gd` run analysis without blocking the editor.
- **Batch analyzer**: `src/batch_analyzer.gd` coordinates parsing, metrics, caching, and reporting.
- **Parsing + metrics**: `src/tokenizer.gd`, `src/control_flow_detector.gd`, `src/cc_calculator.gd`, `src/cog_complexity_calculator.gd`, `src/confidence_calculator.gd`.
- **Reporting**: `src/gd3/report_generator.gd`, `src/gd4/report_generator.gd`.
- **Configuration**: `src/config_manager.gd` and `complexity_config.json`.

## Parser Design

The parser is block-oriented and control-flow focused:
- It detects functions, classes, and control structures.
- Expression parsing is intentionally shallow; only what is needed for CC/C-COG.
- It is a best-effort heuristic parser because Godot does not expose a public AST/tokenizer API.

Accuracy expectations:
- Godot 4.x: typical 90–93% on real code
- Godot 3.x: typical 85–90% on real code
- Godot 3.x confidence is capped at 0.90

## API Reference (Public Entry Points)

Editor:
- `addons/gdscript_complexity/plugin.gd`: plugin lifecycle, analysis trigger, auto export.

CLI:
- `cli/ci_test.gd`: headless analysis for CI and reports.

Reports:
- JSON and CSV are generated by `report_generator.gd` (version-specific).

## Performance Characteristics

- **Incremental caching**: hashes by file content and configuration. Unchanged files are skipped.
- **Batching**: analysis is performed in batches to keep the editor responsive.
- **Reuse of tools**: tokenizer and calculators are reused during a run to reduce allocations.

## Known Limitations

- Parser is not a full AST; complex expressions can reduce accuracy.
- Godot 3.x does not support editor annotations.
- `match` is not supported on Godot 3.x.

## CI/CD Pipeline

The CI workflow runs a multi-version test matrix to validate correctness and performance:
- Godot versions: 3.5.3, 4.0.4, 4.2.0
- Scripts: `tests/ci_test.gd`, `tests/verify_cc_cog.gd`, `tests/validate_confidence.gd`
- Accuracy gate: `Current r^2` must be >= 0.70
- Artifacts: JSON/CSV reports and accuracy metrics

Tag builds (`v*`) create a release zip containing the plugin, documentation, and example config.
